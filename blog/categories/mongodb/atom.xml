<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Mongodb | Prab's Code Blog]]></title>
  <link href="http://prabhakar97.github.io/blog/categories/mongodb/atom.xml" rel="self"/>
  <link href="http://prabhakar97.github.io/"/>
  <updated>2016-06-26T21:37:06-04:00</updated>
  <id>http://prabhakar97.github.io/</id>
  <author>
    <name><![CDATA[Prabhakar Kumar]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Configure DatabaseCleaner With Rspec for Mongoid 5 and Beyond]]></title>
    <link href="http://prabhakar97.github.io/blog/2016/06/26/configure-database-cleaner-with-rspec-for-mongoid-5-and-beyond/"/>
    <updated>2016-06-26T21:05:22-04:00</updated>
    <id>http://prabhakar97.github.io/blog/2016/06/26/configure-database-cleaner-with-rspec-for-mongoid-5-and-beyond</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/DatabaseCleaner/database_cleaner">Database Cleaner</a> is a nifty gem for streamlining tests. Configuring it is straightforward
but it didn&rsquo;t work for me out of the box for Mongoid 5.</p>

<p>Here&rsquo;s my Gemfile segment for testing.</p>

<pre><code class="ruby Gemfile">group :test do
  gem "factory_girl_rails"
  gem "rspec-rails", '~&gt; 3.4'
  gem 'faker'
  gem 'database_cleaner', git: 'git://github.com/DatabaseCleaner/database_cleaner.git'
end
</code></pre>

<p>I added a <code>require 'support/database_cleaner'</code> in my <code>spec_helper</code>. And here&rsquo;s my <code>database_cleaner.rb</code>.</p>

<pre><code class="ruby spec/support/database_cleaner.rb">RSpec.configure do |config|

  config.before(:suite) do
    DatabaseCleaner.strategy = :truncation
    DatabaseCleaner.clean
  end

  config.before(:each) do
    DatabaseCleaner.start
  end

  config.after(:each) do
    DatabaseCleaner.clean
  end

end
</code></pre>

<p>When I ran my spec, I was greeted with an unexpected ugly error.</p>

<pre><code class="text">/home/prabhakar/.rbenv/versions/2.3.0/lib/ruby/gems/2.3.0/bundler/gems/database_cleaner-f052d64d3be9/lib/database_cleaner/mongo2/truncation_mixin.rb:29:in `collections': undefined method `collections' for #&lt;Mongo::Client:0x47021052998580 cluster=127.0.0.1:27017&gt; (NoMethodError)
    from /home/prabhakar/.rbenv/versions/2.3.0/lib/ruby/gems/2.3.0/bundler/gems/database_cleaner-f052d64d3be9/lib/database_cleaner/mongo2/truncation_mixin.rb:9:in `clean'
    from /home/prabhakar/.rbenv/versions/2.3.0/lib/ruby/gems/2.3.0/bundler/gems/database_cleaner-f052d64d3be9/lib/database_cleaner/base.rb:92:in `clean'
    from /home/prabhakar/.rbenv/versions/2.3.0/lib/ruby/gems/2.3.0/bundler/gems/database_cleaner-f052d64d3be9/lib/database_cleaner/configuration.rb:79:in `block in clean'
    from /home/prabhakar/.rbenv/versions/2.3.0/lib/ruby/gems/2.3.0/bundler/gems/database_cleaner-f052d64d3be9/lib/database_cleaner/configuration.rb:79:in `each'
    from /home/prabhakar/.rbenv/versions/2.3.0/lib/ruby/gems/2.3.0/bundler/gems/database_cleaner-f052d64d3be9/lib/database_cleaner/configuration.rb:79:in `clean'
</code></pre>

<p>After looking at the code in the gem, I finally found out what was wrong in it. I created a
<a href="https://github.com/prabhakar97/database_cleaner/commit/3cf0d1b81e4a118fd173d697f032a9aff4f431de">commit for fix</a> and submitted a pull request to
the maintainer. Looking at my commit and the relevant files <a href="https://github.com/DatabaseCleaner/database_cleaner/blob/master/lib/database_cleaner/mongoid/truncation.rb">truncation.rb</a> and <a href="https://github.com/DatabaseCleaner/database_cleaner/blob/master/lib/database_cleaner/mongo2/truncation_mixin.rb">truncation_mixin.rb</a>, you should be able to piece together the problem.</p>

<p>Meanwhile, if you are using Mongoid 5 and aren&rsquo;t able to get it working you could simply point to my fork of database_cleaner by updating your Gemfile
to have:</p>

<pre><code class="ruby Gemfile">gem 'database_cleaner', git: 'git://github.com/prabhakar97/database_cleaner.git'
</code></pre>
]]></content>
  </entry>
  
</feed>
