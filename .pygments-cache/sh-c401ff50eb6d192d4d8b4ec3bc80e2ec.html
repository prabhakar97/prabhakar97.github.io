<div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Check if unicorn is already running</span>
<span class="nv">unicorn_pid</span><span class="o">=</span><span class="k">$(</span>ps -ef | grep <span class="s2">&quot;unicorn_rails master&quot;</span> | grep -v grep | awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="k">if</span> <span class="o">[[</span> ! -z <span class="nv">$unicorn_pid</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;Unicorn is already running. Sending USR2 to it&quot;</span>
  <span class="nb">kill</span> -USR2 <span class="nv">$unicorn_pid</span>
  <span class="c"># Wait till new master comes up so two instances of workers are there</span>
  <span class="k">while</span> <span class="o">[[</span> <span class="k">$(</span>ps -ef | grep <span class="s1">&#39;unicorn_rails worker\[0\]&#39;</span> | grep -v grep | wc -l<span class="k">)</span> -ne 2 <span class="o">]]</span>; <span class="k">do</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Waiting till new master comes up and spawns new workers&quot;</span>
    sleep 1
  <span class="k">done</span>
  <span class="c"># Send WINCH to old master</span>
  <span class="nb">echo</span> <span class="s2">&quot;Winching ID $unicorn_pid&quot;</span>
  <span class="nb">kill</span> -WINCH <span class="nv">$unicorn_pid</span>
  <span class="c"># Wait till old workers die</span>
  <span class="k">while</span> <span class="o">[[</span> <span class="k">$(</span>ps -ef | grep <span class="s1">&#39;unicorn_rails worker\[0\]&#39;</span> | grep -v grep | wc -l<span class="k">)</span> -ne 1 <span class="o">]]</span>; <span class="k">do</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Waiting till old workers die&quot;</span>
    sleep 1
  <span class="k">done</span>
<span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;Killing ID $unicorn_pid&quot;</span>
  <span class="nb">kill</span> -QUIT <span class="nv">$unicorn_pid</span>
<span class="k">else</span>
<span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;Start fresh copy of unicorn&quot;</span>
  unicorn_rails -c config/unicorn.rb -D
<span class="k">fi</span>
</pre></div>